# Coturn TURN Server Configuration for HealthLink
# Generated: 2025-11-26
# Purpose: WebRTC NAT traversal for video calls

# ==================== LISTENING CONFIGURATION ====================

# Listening port for TURN/STUN
listening-port=3478

# TLS listening port for TURNS
tls-listening-port=5349

# Listen on all IPv4 addresses
listening-ip=0.0.0.0

# External IP will be auto-detected via Docker environment
# If auto-detection fails, set manually: external-ip=YOUR_PUBLIC_IP

# Relay IP address (same as listening IP for Docker)
relay-ip=0.0.0.0

# ==================== AUTHENTICATION ====================

# Use long-term credential mechanism (recommended for WebRTC)
lt-cred-mech

# Static user credentials for development
# Format: username:password
# Production: Use time-limited credentials with HMAC-SHA1
user=healthlink:healthlink_turn_secret_2025
user=test:test123

# Realm for authentication (must match client config)
realm=healthlink.com

# ==================== SECURITY & FINGERPRINTING ====================

# Support STUN FINGERPRINT attribute
fingerprint

# Deny TURN functionality for STUN-only users
# stun-only

# Disable multicast peers (security)
no-multicast-peers

# Disable loopback peers (security)
no-loopback-peers

# ==================== RELAY CONFIGURATION ====================

# Minimum and maximum relay port range (reduced for development)
min-port=49152
max-port=49252

# Allow both UDP and TCP relay
# udp-relay
# tcp-relay

# Relay threads for performance
relay-threads=50

# ==================== LOGGING ====================

# Verbose logging (disable in production for performance)
verbose

# Log to stdout (captured by Docker)
log-file=stdout

# Suppress some logs for production
no-stdout-log

# ==================== PERFORMANCE & LIMITS ====================

# Maximum allocations per session
max-allocate-lifetime=600

# Maximum number of relay endpoints per allocation
max-relay-per-alloc=5

# Total quota in bytes (0 = unlimited)
total-quota=100

# Bandwidth per user in KBps (0 = unlimited)
bps-capacity=0

# ==================== DATABASE (Optional) ====================

# For production with Redis authentication backend:
# redis-userdb="ip=redis port=6379 dbname=2 password=healthlink_redis_pass connect_timeout=30"

# For production with PostgreSQL authentication backend:
# psql-userdb="host=postgres dbname=healthlink user=healthlink_user password=healthlink_password_123"

# ==================== TLS/DTLS (Production) ====================

# TLS/DTLS certificate (generate with Let's Encrypt in production)
# cert=/etc/coturn/certs/turn_server_cert.pem
# pkey=/etc/coturn/private/turn_server_pkey.pem

# For development, allow non-TLS connections
no-tlsv1
no-tlsv1_1
# Use TLS 1.2 and 1.3 only in production

# ==================== WEBRTC OPTIMIZATION ====================

# Enable DTLS for WebRTC
# dtls

# WebRTC-friendly settings
no-cli
no-tcp-relay

# Mobile optimization
stale-nonce=600

# ==================== PROMETHEUS METRICS (Optional) ====================

# Expose Prometheus metrics endpoint
# prometheus
# prometheus-port=9641

# ==================== ADMIN INTERFACE ====================

# CLI admin interface (disabled for security in Docker)
no-cli

# Web admin interface (use with caution, enable only if needed)
# web-admin
# web-admin-ip=0.0.0.0
# web-admin-port=8080

# ==================== ADDITIONAL SECURITY ====================

# Deny access from private IP ranges (RFC1918)
# denied-peer-ip=10.0.0.0-10.255.255.255
# denied-peer-ip=172.16.0.0-172.31.255.255
# denied-peer-ip=192.168.0.0-192.168.255.255

# Allow access from specific IP ranges (whitelist)
# allowed-peer-ip=0.0.0.0-255.255.255.255

# Deny specific peer IPs (blacklist)
# denied-peer-ip=192.168.1.100

# ==================== PRODUCTION RECOMMENDATIONS ====================

# 1. Enable TLS/DTLS with valid certificates
# 2. Use Redis/PostgreSQL for user authentication
# 3. Set external-ip to your server's public IP
# 4. Use time-limited credentials with HMAC-SHA1
# 5. Configure firewall rules for relay ports
# 6. Enable Prometheus metrics for monitoring
# 7. Set appropriate quota limits
# 8. Disable verbose logging
# 9. Use strong passwords for static users
# 10. Regularly rotate credentials

# ==================== TIME-LIMITED CREDENTIALS (Production) ====================

# For production, generate time-limited credentials using HMAC-SHA1:
# 
# Secret key for HMAC (change in production)
# static-auth-secret=healthlink_turn_hmac_secret_change_me_in_production
#
# Client generates credentials:
# timestamp = current_time + ttl (e.g., 86400 for 24 hours)
# username = timestamp + ":" + real_username
# password = base64(hmac_sha1(username, secret))
#
# Backend Java implementation:
# String timestamp = String.valueOf(System.currentTimeMillis() / 1000 + 86400);
# String username = timestamp + ":healthlink";
# Mac hmac = Mac.getInstance("HmacSHA1");
# hmac.init(new SecretKeySpec("secret".getBytes(), "HmacSHA1"));
# String password = Base64.getEncoder().encodeToString(hmac.doFinal(username.getBytes()));

# ==================== MONITORING & HEALTH CHECK ====================

# For Docker health check, ensure STUN binding requests work
# Health check command: turnutils_uclient -v -u healthlink -w healthlink_turn_secret_2025 127.0.0.1
